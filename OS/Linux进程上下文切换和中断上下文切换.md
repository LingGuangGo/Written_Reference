## Linux进程上下文切换和中断上下文切换

| 区别     | 进程上下文切换                             | 中断上下文切换                                      |
| -------- | ------------------------------------------ | --------------------------------------------------- |
| 引发原因 | 进程进行**系统调用**                       | 硬件触发信号, 导致内核调用ISR                       |
| 状态切换 | 用户态 -- > 内核态(**进程**运行于内核空间) | 用户态 -- > 内核态(**硬件**运行于内核空间)          |
| 保存现场 | 进程的三部分内容都切换                     | 内核保存**硬件传递的参数** 和 被中断程序相关寄存器; |
| 切换区别 | 进程切换                                   | 程序中止, 和特定进程无关                            |
|          | 可抢占                                     | 不可抢占                                            |
|          | 不可能同时发生                             |                                                     |

### 内核空间和用户空间

| 两种工作模式       | 内核空间               | 用户空间                                            |
| ------------------ | ---------------------- | --------------------------------------------------- |
| 运行态             | 运行在最高级别(内核态) | 应用程序运行在较低级别(用户态)                      |
| 信任程度           | 所有的操作都受系统信任 | CPU控制着对硬件的直接访问以及对内存的**非授权访问** |
| 权限级             | 0(内核级)              | 3(用户级)                                           |
| 进程寻址空间(0-4)G | 3G-4G                  | 0G-3G                                               |

### 进程上下文切换需要保存三部分内容

+ 发生进程调度时:
  + OS必须对三部分提到的全部信息进行切换，新调度的进程才能运行
+ 模式切换
  + 寄存器级进行切换

1. 用户级上下文
   +  正文、数据、用户堆栈以及共享存储区；
2. 寄存器上下文
   + 通用寄存器、程序寄存器(IP)、处理器状态寄存器(EFLAGS)、栈指针(ESP)
3. 系统级上下文: 
   + 进程控制块task_struct、
   + 内存管理信息(mm_struct、vm_area_struct、pgd、pte)
   + 内核栈